---
title: "Omar Saif Ghobash's Facebook Page Analytics (October 8th 2017 - January 6th 2018)"
output: 
  flexdashboard::flex_dashboard:
    #storyboard: true
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, warning=FALSE, message=FALSE)
#devtools::install_github("ropensci/plotly", force = T)
#devtools::install_github("tidyverse/ggplot2", force = T)
#pacman::p_install_gh("vosonlab/SocialMediaLab")
pacman::p_load(tidyverse, magrittr, stringr, scales, lubridate, tidytext, tidyr, ggthemes, janitor, Rfacebook, plotly, DT, SocialMediaLab, geojsonio, geojsonlint, highcharter, xts, knitr, kableExtra, formattable)

range01 <- function(x){(x - min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))}

hc_world_map <- function(data, iso3 = "iso3", value = "perc", label = "", ...){
  ds <- data[,c(iso3, value)]
  colnames(ds) <- c("iso3", "value")

  high_map <- highcharter::highchart(type = "map") %>% 
    highcharter::hc_add_series(...,
      data = ds,
      name = label,
      mapData = worldgeojson,
      joinBy = "iso3",
      borderWidth = 0.01
    ) 
    #highcharter::hc_colorAxis(stops = highcharter::color_stops()) %>%  
    #highcharter::hc_colorAxis(stops = stops) %>%
    #  highcharter::hc_legend(layout = "vertical", reversed = TRUE,
    #            floating = TRUE, align = "right") %>% 
   
  
  return(high_map)
}

make_xts <- function(variables, date) {
  xts(x=variables, order.by = date)
}

if_else_replace <- function(variables) {
  ifelse(is.na(variables), 0, variables)
}

 na.lomf <- function(x) {

    na.lomf.0 <- function(x) {
        non.na.idx <- which(!is.na(x))
        if (is.na(x[1L])) {
            non.na.idx <- c(1L, non.na.idx)
        }
        rep.int(x[non.na.idx], diff(c(non.na.idx, length(x) + 1L)))
    }

    dim.len <- length(dim(x))

    if (dim.len == 0L) {
        na.lomf.0(x)
    } else {
        apply(x, dim.len, na.lomf.0)
    }
 }
 
```

Report {data-icon="fa-list"}
=========================================

Column {data-width=200}
-------------------------------------

###

<script>
$(document).ready(function(){
    $('[data-toggle="popover"]').popover(); 
});
</script>

```{r}
post_stats <- readr::read_csv("data/post_stats.csv") %>% 
  janitor::clean_names() 

days <- 91

posts <- post_stats %>% filter(!is.na(permalink)) %>% 
  nrow()

page_views <- readr::read_csv("data/page_views.csv") %>% janitor::clean_names()

descriptives <- as.list(page_views[1,])

views <- page_views %>% filter(!is.na(date)) %>% 
  select(-date) %>% 
  mutate_all(funs(as.numeric)) %>% 
  cbind(page_views %>% filter(!is.na(date)) %>% select(date), .) %>% 
  select(daily_total_views_count_per_page) %>% 
  mutate_all(sum) %>% 
  .[1,]

# impressions <- 316444

newdat <- data.frame(key = c("total_posts", "page_views"), value = c(posts, views))


dailies <- readr::read_csv("data/dailies.csv") %>% janitor::clean_names()

dscrs2 <- as.list(dailies[1,])

labels <- c("Total Posts", 
            "Total Views Count", 
as.character(dailies[1,])[-1] %>% str_replace("Daily: ", ""))

n_lks <- dailies %>% 
  filter(!is.na(date)) %>% 
  select(daily_new_likes) %>% 
  mutate_all(as.numeric) %>% 
  sum(., na.rm = T)

tab <- dailies %>% filter(!is.na(date)) %>% 
  select(-date) %>% 
  mutate_all(funs(as.numeric)) %>% 
#  cbind(pages %>% filter(!is.na(date)) %>% select(date), .) %>% 
  summarise_all(funs(sum(., na.rm = T))) %>% 
  gather() #%>% 
#  mutate(value = color_bar("red")(value))
#  cbind(labels) %>% 

tab <- newdat %>% 
  rbind(tab) %>% 
  mutate(key = c("Total Posts", "Total Page Views", 
"Total Page Stories", "Total Impressions", "Total Reach", 
"Engaged Users", "Total Post Engagements", "Total Page Consumptions", 
"Consumers", "Total New Likes", "New Likes (Unique Users)", 
"Total Unlikes", "Unlikes (Unique Users)", "Total New Follows", "New Follows (Unique Users)", 
"Total Video Views"))

tab$key <- cell_spec(
  tab$key, # Cell texts
  popover = spec_popover(
    content = labels,
    title = NULL,                           # title will add a Title Panel on top
    position = "right"
  )) 

x <- tab %>% 
    knitr::kable(escape = F, "html") %>%
    kable_styling(bootstrap_options = "striped", 
                full_width = T) %>%
  group_rows("Basic Statistics", 1, 5, label_row_css = "background-color: #2780e3; color: #fff;") %>% 
  group_rows("Engagement", 6, 7, label_row_css = "background-color: #2780e3; color: #fff;") %>% 
  group_rows("Consumption", 8, 9, label_row_css = "background-color: #2780e3; color: #fff;") %>%  
  group_rows("Likes, Unlikes and Follows", 10, 15, label_row_css = "background-color: #2780e3; color: #fff;") %>%   
  group_rows("Video Statistics", 16, 16, label_row_css = "background-color: #2780e3; color: #fff;") #%>%
#  row_spec(1:16, italic = T, color = "black")

gsub("<thead>.*</thead>", "", x)

```



Row {.tabset .tabset-fade}
-------------------------------------

### Post with Most Reach and Impressions


```{r}
url <- post_stats %>% 
  filter(lifetime_post_total_impressions == max(as.numeric(post_stats$lifetime_post_total_impressions), na.rm = T)) %>% select(permalink)
```

<br>
<center>
[**Link to Post with Most Reach and Impressions**](`r url`)


```{r}
x <- post_stats %>% 
  filter(lifetime_post_total_impressions == max(as.numeric(post_stats$lifetime_post_total_impressions), na.rm = T)) %>% select(lifetime_post_total_impressions, lifetime_post_total_reach) %>% 
  gather() %>% 
  mutate(key = c("Post Impressions", "Post Reach")) %>% 
    knitr::kable(escape = F, "html") %>%
    kable_styling(bootstrap_options = "striped", 
                  full_width = F,
                  position = "center") # %>%
#  group_rows("", 1, 2, label_row_css = "background-color: #2780e3; color: #fff;")

gsub("<thead>.*</thead>", "", x)
```

<img src = "images/most_reach_post.png" width = "40%" align = "middle"> 
</center>

### Post that Produced Most Stories

```{r}
url <- post_stats %>% 
  filter(lifetime_post_stories == max(as.numeric(post_stats$lifetime_post_stories), na.rm = T)) %>% select(permalink)
```


<br>
<center>
[**Link to Post that Produced Most Stories**](`r url`)



```{r}
x <- post_stats %>% 
  filter(lifetime_post_stories == max(as.numeric(post_stats$lifetime_post_stories), na.rm = T)) %>% select(lifetime_post_stories) %>% 
  gather() %>% 
  rbind(data.frame(key = c("likes", "comments"), value = c("783", "30"))) %>% 
  mutate(key = c("Stories Produced by Post", "Total Reactions to Post", "Total Comments")) %>% 
    knitr::kable(escape = F, "html") %>%
    kable_styling(bootstrap_options = "striped", 
                  full_width = F,
                  position = "center") # %>%
#  group_rows("", 1, 2, label_row_css = "background-color: #2780e3; color: #fff;")

gsub("<thead>.*</thead>", "", x)

#post_stats %>% 
#  filter(lifetime_post_stories == max(as.numeric(post_stats$lifetime_post_stories), na.rm = T)) %>% #select(permalink)

```

<img src = "images/most_stories.png" width = "40%" align = "middle"> 
</center>


### Post with Most Consumptions and Consumers

```{r}
url <- post_stats %>% 
  filter(lifetime_post_consumptions == max(as.numeric(post_stats$lifetime_post_consumptions), na.rm = T)) %>% select(permalink)
```
<br>
<center>
[**Link to Post with Most Consumptions and Consumers**](`r url`)

```{r}
x <- post_stats %>% 
  filter(lifetime_post_consumptions == max(as.numeric(post_stats$lifetime_post_consumptions), na.rm = T)) %>% select(lifetime_post_consumptions, lifetime_post_consumers) %>% 
  gather() %>% 
  mutate(key = c("Number of Clicks on Post", "The Number of People who Clicked")) %>% 
    knitr::kable(escape = F, "html") %>%
    kable_styling(bootstrap_options = "striped", 
                  full_width = F,
                  position = "center") # %>%
#  group_rows("", 1, 2, label_row_css = "background-color: #2780e3; color: #fff;")

gsub("<thead>.*</thead>", "", x)

#post_stats %>% 
#  filter(lifetime_post_stories == max(as.numeric(post_stats$lifetime_post_stories), na.rm = T)) %>% #select(permalink)

```

<img src = "images/most_consume.png" width = "40%" align = "middle"> 
</center>



### Post with Most Shares

<br>
<center>
[**Link to Post with Most Shares**](https://www.facebook.com/OmarSGhobash/posts/2019727301588989)

```{r}
load("data/postings.Rdata")

x <- postings %>% 
  filter(shares_count == max(as.numeric(postings$shares_count), na.rm = T)) %>% select(shares_count) %>% 
  gather() %>% 
  mutate(key = c("Total Shares")) %>% 
    knitr::kable(escape = F, "html") %>%
    kable_styling(bootstrap_options = "striped", 
                  full_width = F,
                  position = "center") # %>%
#  group_rows("", 1, 2, label_row_css = "background-color: #2780e3; color: #fff;")

gsub("<thead>.*</thead>", "", x)

#post_stats %>% 
#  filter(lifetime_post_stories == max(as.numeric(post_stats$lifetime_post_stories), na.rm = T)) %>% #select(permalink)

post_likes <- sum(postings$likes_count)
post_comments_count <- sum(postings$comments_count)
```

<img src = "images/shares.png" width = "40%" align = "middle"> 
</center>


Row {data-width=180}
-----------------------------------------------------------------------

### New Page Likes per Day

```{r}
flexdashboard::valueBox(round(n_lks / days), icon = "fa-thumbs-o-up", color = "#2780e3")
```

### Engaged Users per Day

```{r}
flexdashboard::valueBox(round(22735 / days), icon = "fa-user", color = "#2780e3")
```


### Reached Users per Day

```{r}
flexdashboard::valueBox(round(185502 / days), icon = "fa-users", color = "#2780e3")
```



### Posts per Day

```{r}

flexdashboard::valueBox(round(posts / days), icon = "fa-pencil", color = "#2780e3")
```

### Likes per Post

```{r}

flexdashboard::valueBox(round(post_likes / posts), icon = "fa-thumbs-o-up", color = "#2780e3")
```



### Comments per Post

```{r}
flexdashboard::valueBox(round(post_comments_count / posts), icon = "fa-comments", color = "#2780e3")
```



Likes, Follows and Reach by Age and Gender {data-navmenu="Audience by Age and Gender"}
=========================================

Column {.tabset .tabset-fade}
-------------------------------------

###

```{r}

agender_likes <- readr::read_csv("data/agender_likes.csv") %>% janitor::clean_names()

agenders <- colnames(agender_likes)[-1] %>% str_extract(".......$") 

agenders[7] <- "f_f_65"
agenders[14] <- "m_m_65"
agenders[20] <- "u_u_65"

colnames(agender_likes) <- c("date", agenders)

agender_likes %<>% 
  filter(!is.na(date)) %>% 
  select(-u_13_17, -u_25_34, -u_35_44, -u_45_54, -u_55_64, -u_u_65) %>% 
  gather("agender", "Likes", -date) 

genders <- agender_likes$agender %>% str_split("_") %>% 
  as.data.frame %>% janitor::clean_names()

agender_likes$Gender <- as.character(as_vector(genders[1,]))
agender_likes$Age <- paste0(as.character(as_vector(genders[2,])), "-", as.character(as_vector(genders[3,])))



gg_dat <- agender_likes %>%
  mutate(Age = case_when(
    Age == "f-65" ~ "65+",
    Age == "m-65" ~ "65+",
    TRUE ~ as.character(Age)
  )) %>% 
  mutate(Likes = as.numeric(Likes)) %>% 
  mutate(Likes = ifelse(Gender == "f", -Likes, Likes)) %>% 
  mutate(Gender = ifelse(Gender == "f", "Female", "Male")) %>% 
  mutate(Gender = fct_rev(factor(Gender))) 

gg_plot <- gg_dat %>% 
ggplot(aes(x=Age, y=Likes, fill=Gender)) + 
  geom_bar(stat="identity", position="identity", aes(x=Age, y=Likes, fill=Gender)) + 
  geom_bar(stat="identity", position="identity") + 
  theme(legend.position="bottom") +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight() +
  ggtitle("Total Page Likes by Gender and Age") +
  xlab("Age Groups") +
  ylab("Likes") + 
  guides(fill=guide_legend(title="")) + coord_flip()

  plotly::ggplotly(gg_plot, height = 635)  %>%
  layout(legend = list(x = 0.7, y = 0.9, font = list(size = 18)))


```

Column {.tabset .tabset-fade}
-------------------------------------

###

```{r}

agender_follows <- readr::read_csv("data/agender_follows.csv") %>% janitor::clean_names()

agenders <- colnames(agender_follows)[-1] %>% str_extract(".......$") 

agenders[7] <- "f_f_65"
agenders[14] <- "m_m_65"
agenders[20] <- "u_u_65"

colnames(agender_follows) <- c("date", agenders)

agender_follows %<>% 
  filter(!is.na(date)) %>% 
  select(-u_13_17, -u_25_34, -u_35_44, -u_45_54, -u_55_64, -u_u_65) %>% 
  gather("agender", "Follows", -date) 

genders <- agender_follows$agender %>% str_split("_") %>% 
  as.data.frame %>% janitor::clean_names()

agender_follows$Gender <- as.character(as_vector(genders[1,]))
agender_follows$Age <- paste0(as.character(as_vector(genders[2,])), "-", as.character(as_vector(genders[3,])))



gg_dat <- agender_follows %>%
  mutate(Age = case_when(
    Age == "f-65" ~ "65+",
    Age == "m-65" ~ "65+",
    TRUE ~ as.character(Age)
  )) %>% 
  mutate(Follows = as.numeric(Follows)) %>% 
  mutate(Follows = ifelse(Gender == "f", -Follows, Follows)) %>% 
  mutate(Gender = ifelse(Gender == "f", "Female", "Male")) %>% 
  mutate(Gender = fct_rev(factor(Gender))) 

gg_plot <- gg_dat %>% 
ggplot(aes(x=Age, y=Follows, fill=Gender)) + 
  geom_bar(stat="identity", position="identity", aes(x=Age, y=Follows, fill=Gender)) + 
  geom_bar(stat="identity", position="identity") + 
  theme(legend.position="bottom") +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight() +
  ggtitle("Total Page Follows by Gender and Age") +
  xlab("Age Groups") +
  ylab("Follows") + 
  guides(fill=guide_legend(title="")) + coord_flip()

  plotly::ggplotly(gg_plot, height = 635)  %>%
  layout(legend = list(x = 0.7, y = 0.9, font = list(size = 18)))


```

Column {.tabset .tabset-fade}
-------------------------------------

###

```{r}
daily_reach_demos <- readr::read_csv("data/daily_reach_demos.csv") %>% janitor::clean_names()


agenders <- colnames(daily_reach_demos)[-1] %>% str_extract(".......$") 

agenders[7] <- "f_f_65"
agenders[14] <- "m_m_65"
agenders[20] <- "u_u_65"

colnames(daily_reach_demos) <- c("date", agenders)

daily_reach_demos %<>% 
  filter(!is.na(date)) %>% 
  select(-u_13_17, -u_18_24, -u_25_34, -u_35_44, -u_45_54, -cs_u_65, -u_u_65) %>% 
  gather("agender", "Reach", -date) 

genders <- daily_reach_demos$agender %>% str_split("_") %>% 
  as.data.frame %>% janitor::clean_names()

daily_reach_demos$Gender <- as.character(as_vector(genders[1,]))
daily_reach_demos$Age <- paste0(as.character(as_vector(genders[2,])), "-", as.character(as_vector(genders[3,])))



gg_dat <- daily_reach_demos %>%
  mutate(Age = case_when(
    Age == "f-65" ~ "65+",
    Age == "m-65" ~ "65+",
    TRUE ~ as.character(Age)
  )) %>% 
  mutate(Reach = as.numeric(Reach)) %>% 
  mutate(Reach = ifelse(Gender == "f", -Reach, Reach)) %>% 
  mutate(Gender = ifelse(Gender == "f", "Female", "Male")) %>% 
  mutate(Gender = fct_rev(factor(Gender))) 

gg_plot <- gg_dat %>% 
ggplot(aes(x=Age, y=Reach, fill=Gender)) + 
  geom_bar(stat="identity", position="identity", aes(x=Age, y=Reach, fill=Gender)) + 
  geom_bar(stat="identity", position="identity") + 
  theme(legend.position="bottom") +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight() +
  ggtitle("Page Reach by Gender and Age") +
  xlab("Age Groups") +
  ylab("Unique Users") + 
  guides(fill=guide_legend(title="")) + coord_flip()

  plotly::ggplotly(gg_plot, height = 635)  %>%
  layout(legend = list(x = 0.7, y = 0.9, font = list(size = 18)))

```





Facebook Page Likes {data-navmenu="Page Impact"}
=========================================

Column {.tabset .tabset-fade}
-------------------------------------

### Total - Facebook Page Likes

```{r}
like_offensive <- readr::read_csv("data/like_offensive.csv") %>% janitor::clean_names()

descriptives <- as.list(like_offensive[1,])

like_offensive %<>% filter(!is.na(date)) %>% 
  select(-date) %>% 
  mutate_all(funs(as.numeric)) %>% 
  cbind(like_offensive %>% filter(!is.na(date)) %>% select(date), .)

highchart(type = "stock")  %>%
  #hc_add_series(sent_total, color = "blue") %>% 
  #hc_credits(enabled = TRUE) %>%
  #hc_exporting(enabled = TRUE) 
#  hc_add_series(
#  make_xts(cumsum_reach$daily_total_reach, cumsum_reach$date), 
#  name = "Total Reach", type = "line", color = "darkblue"
#  ) %>% 
  hc_add_series(
  make_xts(like_offensive$lifetime_total_likes, like_offensive$date), 
  name = "Total Likes", type = "area", color = "red"
  ) %>% 
  hc_add_series(
  make_xts(like_offensive$lifetime_total_follows, like_offensive$date), 
  name = "Total Follows", type = "area", color = "green"
  ) %>% 
#  hc_add_series(
#  make_xts(cumsum_reach$daily_viral_reach, cumsum_reach$date), 
#  name = "Total Viral Reach", type = "area", color = "grey"
#  )    %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_legend(enabled = T, align = "right", verticalAlign = "top",
            layout = "vertical", x = -50, y = 30, 
            floating = T, itemStyle = list(
            color = 'black',
            fontSize = "13px"
   )) %>% 
  hc_rangeSelector(enabled = T, buttons = list(
    list(type = 'all', text = 'All'),
    list(type = 'month', count = 3, text = '3M'),
    list(type = 'month', count = 2, text = '2M'),
    list(type = 'month', count = 1, text = '1M'),
    list(type = 'week', count = 2, text = '2Wks'),
    list(type = 'week', count = 1, text = '1Wk')
  )) %>% 
  hc_exporting(
    enabled = TRUE
  ) %>% 
  hc_plotOptions(area = list(
    stacking = "normal",
    lineColor = "#666666",
    lineWidth = 1,
    marker = list(
      lineWidth = 1,
      lineColor = "666666"
    )
  ))



```

### Daily - Facebook Page Likes

```{r}


highchart(type = "stock")  %>%
  #hc_add_series(sent_total, color = "blue") %>% 
  #hc_credits(enabled = TRUE) %>%
  #hc_exporting(enabled = TRUE) 
  hc_add_series(
  make_xts(like_offensive$daily_new_likes, like_offensive$date), 
  name = "Daily New Likes", type = "line", color = "darkblue"
  ) %>% 
  hc_add_series(
  make_xts(like_offensive$daily_unlikes, like_offensive$date), 
  name = "Daily Unlikes", type = "line", color = "red"
  ) %>% 
  hc_add_series(
  make_xts(like_offensive$daily_new_follows, like_offensive$date), 
  name = "Daily New Follows", type = "line", color = "green"
  ) %>% 
  hc_add_series(
  make_xts(like_offensive$daily_new_unfollows, like_offensive$date), 
  name = "Daily Unfollows", type = "line", color = "grey"
  )    %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_legend(enabled = T, align = "right", verticalAlign = "top",
            layout = "vertical", x = -50, y = 30, 
            floating = T, itemStyle = list(
            color = 'black',
            fontSize = "13px"
   )) %>% 
  hc_rangeSelector(enabled = T, buttons = list(
    list(type = 'all', text = 'All'),
    list(type = 'month', count = 3, text = '3M'),
    list(type = 'month', count = 2, text = '2M'),
    list(type = 'month', count = 1, text = '1M'),
    list(type = 'week', count = 2, text = '2Wks'),
    list(type = 'week', count = 1, text = '1Wk')
  )) %>% 
  hc_exporting(
    enabled = TRUE
  )

```



Column {data-width=280}
-------------------------------------

### Descriptives

*Click on the Names in the Legend to enable/disable their visualization in the chart*

*Legend:*

**(Daily) Total Likes**

The number of people who have liked your Page (Total Count)

**(Daily) Total Unlikes**

The number of Unlikes of your Page (Total Count)

**(Daily) Total Follows**

The number of people who have liked your Page (Total Count)

**(Daily) Total Unfollows**

The number of Unlikes of your Page (Total Count)



Impressions of Facebook Page {data-navmenu="Page Impact"}
=========================================


Column {.tabset .tabset-fade}
-------------------------------------

### Total - Impressions of Facebook Page

```{r}

impressions <- readr::read_csv("data/impressions.csv") %>% janitor::clean_names()

descriptives <- as.list(impressions[1,])

impressions %<>% filter(!is.na(date)) %>% 
  select(-date) %>% 
  mutate_all(funs(as.numeric)) %>% 
  cbind(impressions %>% filter(!is.na(date)) %>% select(date), .)

cumsum_impressions <- impressions %>% 
  mutate_if(.predicate = is.numeric, .funs = if_else_replace) %>% 
  mutate_if(.predicate = is.numeric, .funs = cumsum)


highchart(type = "stock")  %>%
  #hc_add_series(sent_total, color = "blue") %>% 
  #hc_credits(enabled = TRUE) %>%
  #hc_exporting(enabled = TRUE) 
#  hc_add_series(
#  make_xts(cumsum_impressions$daily_total_impressions, cumsum_impressions$date), 
#  name = "Total Impressions", type = "line", color = "darkblue"
#  ) %>% 
  hc_add_series(
  make_xts(cumsum_impressions$daily_paid_impressions, cumsum_impressions$date), 
  name = "Total Paid Impressions", type = "area", color = "red"
  ) %>% 
  hc_add_series(
  make_xts(cumsum_impressions$daily_organic_impressions, cumsum_impressions$date), 
  name = "Total Organic Impressions", type = "area", color = "green"
  ) %>% 
  hc_add_series(
  make_xts(cumsum_impressions$daily_viral_impressions, cumsum_impressions$date), 
  name = "Total Viral Impressions", type = "area", color = "grey"
  )    %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_legend(enabled = T, align = "right", verticalAlign = "top",
            layout = "vertical", x = -50, y = 30, 
            floating = T, itemStyle = list(
            color = 'black',
            fontSize = "13px"
   )) %>% 
  hc_rangeSelector(enabled = T, buttons = list(
    list(type = 'all', text = 'All'),
    list(type = 'month', count = 3, text = '3M'),
    list(type = 'month', count = 2, text = '2M'),
    list(type = 'month', count = 1, text = '1M'),
    list(type = 'week', count = 2, text = '2Wks'),
    list(type = 'week', count = 1, text = '1Wk')
  )) %>% 
  hc_exporting(
    enabled = TRUE
  ) %>% 
  hc_plotOptions(area = list(
    stacking = "normal",
    lineColor = "#666666",
    lineWidth = 1,
    marker = list(
      lineWidth = 1,
      lineColor = "666666"
    )
  ))



```


### Daily - Impressions of Facebook Page



```{r}



highchart(type = "stock")  %>%
  #hc_add_series(sent_total, color = "blue") %>% 
  #hc_credits(enabled = TRUE) %>%
  #hc_exporting(enabled = TRUE) 
  hc_add_series(
  make_xts(impressions$daily_total_impressions, impressions$date), 
  name = "Daily Total Impressions", type = "line", color = "darkblue"
  ) %>% 
  hc_add_series(
  make_xts(impressions$daily_paid_impressions, impressions$date), 
  name = "Daily Paid Impressions", type = "line", color = "red"
  ) %>% 
  hc_add_series(
  make_xts(impressions$daily_organic_impressions, impressions$date), 
  name = "Daily Organic Impressions", type = "line", color = "green"
  ) %>% 
  hc_add_series(
  make_xts(impressions$daily_viral_impressions, impressions$date), 
  name = "Daily Viral Impressions", type = "line", color = "grey"
  )    %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_legend(enabled = T, align = "right", verticalAlign = "top",
            layout = "vertical", x = -50, y = 30, 
            floating = T, itemStyle = list(
            color = 'black',
            fontSize = "13px"
   )) %>% 
  hc_rangeSelector(enabled = T, buttons = list(
    list(type = 'all', text = 'All'),
    list(type = 'month', count = 3, text = '3M'),
    list(type = 'month', count = 2, text = '2M'),
    list(type = 'month', count = 1, text = '1M'),
    list(type = 'week', count = 2, text = '2Wks'),
    list(type = 'week', count = 1, text = '1Wk')
  )) %>% 
  hc_exporting(
    enabled = TRUE
  )


```

Column {data-width=280}
-------------------------------------

### Descriptives

*Click on the Names in the Legend to enable/disable their visualization in the chart*


*Legend:*

**(Daily) Total Impressions**

The number of impressions seen of any content associated with your Page. (Total Count)

**(Daily) Paid Impressions**

The number of impressions of a Sponsored Story or Ad pointing to your Page. (Total Count)

**(Daily) Organic Impressions**

The number of times your posts were seen in News Feed or ticker or on visits to your Page. These impressions can be by people who have liked your Page and people who haven't. (Total Count)

**(Daily) Viral Impressions**

The number of impressions of a story published by a friend about your Page. These stories include liking your Page, posting to your Page's Wall, liking, commenting on or sharing one of your Page posts, answering a Question you posted, RSVPing to one of your events, mentioning your Page, phototagging your Page or checking in at your Place. (Total Count)


```{r}
# 
# post_stats <- readr::read_csv("data/post_stats.csv") %>% janitor::clean_names()
# 
# dscrs1 <- as.list(post_stats[1,])
# 
# post_stats %<>% filter(!is.na(permalink)) 
# 
# impressives <- post_stats %>% 
#   select(lifetime_post_total_impressions, 
#          lifetime_post_paid_impressions, 
#          lifetime_post_organic_impressions, 
#          lifetime_post_viral_impressions) %>% 
#   mutate_all(as.numeric) %>% 
#   mutate_all(sum) 

impressives <- cumsum_impressions %>% 
   .[nrow(cumsum_impressions),2:5]

colnames(impressives) <- c("Total Impressions", "Total Paid Impressions", "Total Organic Impressions", "Total Viral Impressions")

impressives %<>% 
#  .[1,] %>% 
  gather() 

colnames(impressives) <- c("Measure", "Total Number (October 8th 2017 - January 6th 2018)")

knitr::kable(impressives)

plot_dat <- impressives[-1,] %>% 
  mutate(perc = round(`Total Number (October 8th 2017 - January 6th 2018)`/sum(`Total Number (October 8th 2017 - January 6th 2018)`)*100,2))



#pos <- c(2, 23, 66) + 5

#cumsum(plot_dat$perc) - (0.5 * plot_dat$perc) - 20



# plot_dat %>% 
# ggplot(aes(x = 1, y = perc, fill = Measure)) + 
#     #geom_bar(position = "fill",stat = "identity") +
#     # or:
#      geom_bar(position = position_fill(), stat = "identity") +
#     scale_y_continuous(labels = percent_format()) +
#   theme_hc() +
# #  viridis::scale_fill_viridis(discrete = T, option = "C") +
#   scale_fill_manual(values = c("#4DD946DF", "#FA3A3AE9", "#616161E0"))  +
# 
#   coord_flip() + 
# #  coord_fixed(xlim = 0.25) +
#   geom_text(data=plot_dat,
#             aes(x = 1, 
#                 y = pos*0.01, 
#                 label = paste0(perc,"%")),
#                size = 4, color = "black") +
#   theme(axis.title.y=element_blank(),
#         axis.title.x=element_blank(),
#         axis.text.y=element_blank(),
#         axis.ticks.y=element_blank(),
#         legend.position = "top") + 
#   guides(fill=guide_legend(title="Impression by Type"))

#plotly::ggplotly(width = 500, height = 200)
  
 ax <- list(
   title = "",
   zeroline = FALSE,
   showline = FALSE,
   showticklabels = FALSE,
   showgrid = FALSE
 )
 
 m <- list(
   l = 10,
   r = 10,
   b = 20,
   t = 30,
   pad = 0
 )
 
 plotly::plot_ly(plot_dat, 
                 x = ~perc, 
                 y = ~1, 
                 orientation = 'h', 
                 type = 'bar',
                 color = ~Measure,
                 text = ~perc, 
                 hoverinfo = 'text') %>% 
 plotly::layout(legend = 
                  list(orientation = 'v'),
                title = "Percentage (%)",
                xaxis = 
                  list(title = ''),
                yaxis = ax,
                barmode = "stack", 
                autosize = F, width = 600, height = 130, margin = m) 

# prc_chart <- post_stats %>% 
#   select(lifetime_post_total_impressions, 
#          lifetime_post_paid_impressions, 
#          lifetime_post_organic_impressions, 
#          lifetime_post_viral_impressions) %>% 
#   mutate_all(as.numeric) %>% 
#   mutate_all(sum) %>% 
#   mutate(lifetime_post_paid_impressions = round(100*lifetime_post_paid_impressions/
#                                                   lifetime_post_total_impressions,2)) %>% 
#   mutate(lifetime_post_organic_impressions = round(100*lifetime_post_organic_impressions/
#                                                      lifetime_post_total_impressions,2)) %>% 
#   mutate(lifetime_post_viral_impressions = round(100*lifetime_post_viral_impressions/
#                                                    lifetime_post_total_impressions,2)) %>% 
#   select(-lifetime_post_total_impressions)
# 
# 
# colnames(prc_chart) <- c("Daily Paid Impressions", "Daily Organic Impressions", "Daily Viral # Impressions")
# 
# prc_chart %<>% 
#   .[1,] 
# 
# 
# 
# 
#  highchart() %>%
#   hc_xAxis(categories = "%",
#            title = "Percentages") %>% 
#   hc_add_series(data = prc_chart$`Daily Organic Impressions`,
#                 name = "Daily Organic Impressions") %>%   
#   hc_add_series(data = prc_chart$`Daily Paid Impressions`,
#                 name = "Daily Paid Impressions") %>%  
#   hc_add_series(data = prc_chart$`Daily Viral Impressions`,
#                 name = "Daily Viral Impressions") %>%    
#   hc_chart(type = "bar") %>%
#   hc_plotOptions(series = list(stacking = "percent")) %>%
#   hc_yAxis(title = list(text = "Percentage")) %>%
#   hc_legend(reversed = TRUE) %>% 
#   hc_add_theme(hc_theme_smpl()) %>% 
#   hc_size(300, 200)  %>%
#   hc_legend(enabled = T, align = "center", verticalAlign = "top",
#             layout = "vertical"
#    )
 
```




Reach of Facebook Page  {data-navmenu="Page Impact"}
=========================================

Column {.tabset .tabset-fade}
-------------------------------------

### Total - Impressions of Facebook Page

```{r}
reach <- readr::read_csv("data/reach.csv") %>% janitor::clean_names()

descriptives <- as.list(reach[1,])

reach %<>% filter(!is.na(date)) %>% 
  select(-date) %>% 
  mutate_all(funs(as.numeric)) %>% 
  cbind(reach %>% filter(!is.na(date)) %>% select(date), .)

cumsum_reach <- reach %>% 
  mutate_if(.predicate = is.numeric, .funs = if_else_replace) %>% 
  mutate_if(.predicate = is.numeric, .funs = cumsum)


highchart(type = "stock")  %>%
  #hc_add_series(sent_total, color = "blue") %>% 
  #hc_credits(enabled = TRUE) %>%
  #hc_exporting(enabled = TRUE) 
#  hc_add_series(
#  make_xts(cumsum_reach$daily_total_reach, cumsum_reach$date), 
#  name = "Total Reach", type = "line", color = "darkblue"
#  ) %>% 
  hc_add_series(
  make_xts(cumsum_reach$daily_paid_reach, cumsum_reach$date), 
  name = "Total Paid Reach", type = "area", color = "red"
  ) %>% 
  hc_add_series(
  make_xts(cumsum_reach$daily_organic_reach, cumsum_reach$date), 
  name = "Total Organic Reach", type = "area", color = "green"
  ) %>% 
  hc_add_series(
  make_xts(cumsum_reach$daily_viral_reach, cumsum_reach$date), 
  name = "Total Viral Reach", type = "area", color = "grey"
  )    %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_legend(enabled = T, align = "right", verticalAlign = "top",
            layout = "vertical", x = -50, y = 30, 
            floating = T, itemStyle = list(
            color = 'black',
            fontSize = "13px"
   )) %>% 
  hc_rangeSelector(enabled = T, buttons = list(
    list(type = 'all', text = 'All'),
    list(type = 'month', count = 3, text = '3M'),
    list(type = 'month', count = 2, text = '2M'),
    list(type = 'month', count = 1, text = '1M'),
    list(type = 'week', count = 2, text = '2Wks'),
    list(type = 'week', count = 1, text = '1Wk')
  )) %>% 
  hc_exporting(
    enabled = TRUE
  ) %>% 
  hc_plotOptions(area = list(
    stacking = "normal",
    lineColor = "#666666",
    lineWidth = 1,
    marker = list(
      lineWidth = 1,
      lineColor = "666666"
    )
  ))



```

### Daily - Reach of Facebook Page

```{r}


highchart(type = "stock")  %>%
  #hc_add_series(sent_total, color = "blue") %>% 
  #hc_credits(enabled = TRUE) %>%
  #hc_exporting(enabled = TRUE) 
  hc_add_series(
  make_xts(reach$daily_total_reach, reach$date), 
  name = "Daily Total Reach", type = "line", color = "darkblue"
  ) %>% 
  hc_add_series(
  make_xts(reach$daily_paid_reach, reach$date), 
  name = "Daily Paid Reach", type = "line", color = "red"
  ) %>% 
  hc_add_series(
  make_xts(reach$daily_organic_reach, reach$date), 
  name = "Daily Organic Reach", type = "line", color = "green"
  ) %>% 
  hc_add_series(
  make_xts(reach$daily_viral_reach, reach$date), 
  name = "Daily Viral Reach", type = "line", color = "grey"
  )    %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_legend(enabled = T, align = "right", verticalAlign = "top",
            layout = "vertical", x = -50, y = 30, 
            floating = T, itemStyle = list(
            color = 'black',
            fontSize = "13px"
   )) %>% 
  hc_rangeSelector(enabled = T, buttons = list(
    list(type = 'all', text = 'All'),
    list(type = 'month', count = 3, text = '3M'),
    list(type = 'month', count = 2, text = '2M'),
    list(type = 'month', count = 1, text = '1M'),
    list(type = 'week', count = 2, text = '2Wks'),
    list(type = 'week', count = 1, text = '1Wk')
  )) %>% 
  hc_exporting(
    enabled = TRUE
  )

```

Column {data-width=280}
-------------------------------------

### Descriptives

*Click on the Names in the Legend to enable/disable their visualization in the chart*

*Legend:*

**(Daily) Total Reach**

The number of people who have seen any content associated with your Page. (Unique Users)

**(Daily) Paid Reach**

The number of people who saw a sponsored story or ad pointing to your Page. (Unique Users)

**(Daily) Organic Reach**

The number of people who visited your Page, or saw your Page or one of its posts in news feed or ticker. These can be people who have liked your Page and people who haven't. (Unique Users)

**(Daily) Viral Reach**

The number of people who saw your Page or one of its posts from a story shared by a friend. These stories include liking your Page, posting to your Page's timeline, liking, commenting on or sharing one of your Page posts, answering a question you posted, responding to one of your events, mentioning your Page, tagging your Page in a photo or checking in at your location. (Unique Users)

```{r}
reaching <- cumsum_reach %>% 
   .[nrow(cumsum_reach),2:5]

colnames(reaching) <- c("Total Reach", "Total Paid Reach", "Total Organic Reach", "Total Viral Reach")

reaching %<>% 
#  .[1,] %>% 
  gather() 

colnames(reaching) <- c("Measure", "Total Number (October 8th 2017 - January 6th 2018)")

knitr::kable(reaching)

plot_dat <- reaching[-1,] %>% 
  mutate(perc = round(`Total Number (October 8th 2017 - January 6th 2018)`/sum(`Total Number (October 8th 2017 - January 6th 2018)`)*100,2))



#pos <- c(2, 23, 66) + 5

#cumsum(plot_dat$perc) - (0.5 * plot_dat$perc) - 20
  
 ax <- list(
   title = "",
   zeroline = FALSE,
   showline = FALSE,
   showticklabels = FALSE,
   showgrid = FALSE
 )
 
 m <- list(
   l = 10,
   r = 10,
   b = 20,
   t = 30,
   pad = 0
 )
 
 plotly::plot_ly(plot_dat, 
                 x = ~perc, 
                 y = ~1, 
                 orientation = 'h', 
                 type = 'bar',
                 color = ~Measure,
                 text = ~perc, 
                 hoverinfo = 'text') %>% 
 plotly::layout(legend = 
                  list(orientation = 'v'),
                title = "Percentage (%)",
                xaxis = 
                  list(title = ''),
                yaxis = ax,
                barmode = "stack", 
                autosize = F, width = 600, height = 130, margin = m) 
```


Consumers and Consumption  {data-navmenu="Page Impact"}
=========================================

Column {.tabset .tabset-fade}
-------------------------------------

### Total - Consumers and Consumption on Facebook Page

```{r}
pages <- readr::read_csv("data/pages.csv") %>% janitor::clean_names()

dscrs2 <- as.list(pages[1,])

pages %<>% filter(!is.na(date)) %>% 
  select(-date) %>% 
  mutate_all(funs(as.numeric)) %>% 
  cbind(pages %>% filter(!is.na(date)) %>% select(date), .)

cumsums <- pages %>% 
  mutate_if(.predicate = is.numeric, .funs = if_else_replace) %>% 
  mutate_if(.predicate = is.numeric, .funs = cumsum)


highchart(type = "stock")  %>%
  #hc_add_series(sent_total, color = "blue") %>% 
  #hc_credits(enabled = TRUE) %>%
  #hc_exporting(enabled = TRUE) 
  hc_add_series(
  make_xts(cumsums$daily_page_consumptions, cumsums$date), 
  name = "Total Page Consumptions", type = "area", color = "red"
  ) %>% 
  hc_add_series(
  make_xts(cumsums$daily_total_consumers, cumsums$date), 
  name = "Total Consumers", type = "area", color = "green"
  ) %>% 
  hc_add_theme(hc_theme_smpl()) %>%
  hc_legend(enabled = T, align = "right", verticalAlign = "top",
            layout = "vertical", x = -50, y = 30, 
            floating = T, itemStyle = list(
            color = 'black',
            fontSize = "13px"
   )) %>% 
  hc_rangeSelector(enabled = T, buttons = list(
    list(type = 'all', text = 'All'),
    list(type = 'month', count = 3, text = '3M'),
    list(type = 'month', count = 2, text = '2M'),
    list(type = 'month', count = 1, text = '1M'),
    list(type = 'week', count = 2, text = '2Wks'),
    list(type = 'week', count = 1, text = '1Wk')
  )) %>% 
  hc_exporting(
    enabled = TRUE
  ) %>% 
  hc_plotOptions(area = list(
    stacking = "normal",
    lineColor = "#666666",
    lineWidth = 1,
    marker = list(
      lineWidth = 1,
      lineColor = "666666"
    )
  ))


```

### Daily - Consumers and Consumption on Facebook Page

```{r}

highchart(type = "stock")  %>%
  #hc_add_series(sent_total, color = "blue") %>% 
  #hc_credits(enabled = TRUE) %>%
  #hc_exporting(enabled = TRUE) 
  hc_add_series(
  make_xts(pages$daily_page_consumptions, pages$date), 
  name = "Daily Page Consumptions", type = "line", color = "red"
  ) %>% 
  hc_add_series(
  make_xts(pages$daily_total_consumers, pages$date), 
  name = "Daily Total Consumers", type = "area", color = "green"
  ) %>% 
  hc_add_theme(hc_theme_smpl()) %>%
  hc_legend(enabled = T, align = "right", verticalAlign = "top",
            layout = "vertical", x = -50, y = 30, 
            floating = T, itemStyle = list(
            color = 'black',
            fontSize = "13px"
   )) %>% 
  hc_rangeSelector(enabled = T, buttons = list(
    list(type = 'all', text = 'All'),
    list(type = 'month', count = 3, text = '3M'),
    list(type = 'month', count = 2, text = '2M'),
    list(type = 'month', count = 1, text = '1M'),
    list(type = 'week', count = 2, text = '2Wks'),
    list(type = 'week', count = 1, text = '1Wk')
  )) %>% 
  hc_exporting(
    enabled = TRUE
  )
```

Column {data-width=180}
-------------------------------------

### Descriptives

*Click on the Names in the Legend to enable/disable their visualization in the chart*

*Legend:*

**(Daily) Page Consumptions**

The number of clicks on any of your content. Stories generated without clicks on page content (e.g., liking the page in Timeline) are not included. (Total Count)

**(Daily) Page Consumers**

The number of people who clicked on any of your content. Stories that are created without clicking on Page content (ex, liking the Page from timeline) are not included. (Unique Users)


```{r, eval = F}
pages <- readr::read_csv("data/pages.csv") %>% janitor::clean_names()

dscrs2 <- as.list(pages[1,])

pages %<>% filter(!is.na(date)) %>% 
  select(-date) %>% 
  mutate_all(funs(as.numeric)) %>% 
  cbind(pages %>% filter(!is.na(date)) %>% select(date), .)



highchart() %>% 
  hc_xAxis(categories = lubridate::as_date(pages$date)) %>% 
  hc_add_series(name = "Daily Page Stories", data = pages$daily_page_stories, color = "red") %>% 
  hc_add_series(name = "Daily Total Impressions", data = pages$daily_total_impressions, color = "red") %>% 
  hc_add_series(name = "Daily Total Reach", data = pages$daily_total_reach, color = "red") %>% 
  hc_add_series(name = "Daily Total Consumers", data = pages$daily_total_consumers, color = "red") %>% 
  hc_add_series(name = "Daily Page Consumptions", data = pages$daily_page_consumptions) %>% 
  hc_add_series(name = "Daily Post Engagements", data = pages$daily_post_engagements) %>%
  hc_add_series(name = "Daily Page Engaged Users", data = pages$daily_page_engaged_users) %>%
  hc_add_series(name = "Daily New Likes", data = pages$daily_new_likes) %>%
  hc_add_series(name = "Daily Unlikes", data = pages$daily_unlikes) %>%
  hc_add_series(name = "Daily New Follows", data = pages$daily_new_follows) %>%
  hc_add_series(name = "Daily Total Video Views", data = pages$daily_new_follows) %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_legend(align = "right", verticalAlign = "top",
            layout = "vertical", x = -40, y = 80, 
            floating = T, itemStyle = list(
            color = 'black',
            fontSize = "13px"
   )) #%>% 
#  hc_rangeSelector(enabled = T, buttons = list(
#    list(type = 'all', text = 'All'),
#    list(type = 'month', count = 1, text = 'Month'),
#    list(type = 'week', count = 2, text = '2 Weeks'),
#    list(type = 'week', count = 1, text = '1 Week'),
#    list(type = 'day', count = 3, text = '3 Days')
#  ))


# highchart() %>% 
#   hc_chart(type = "line") %>% 
#   hc_add_series_df_tidy(data = dat, group = grp, values = value)

  
```

Engagement and Engaged Users  {data-navmenu="Page Impact"}
=========================================

Column {.tabset .tabset-fade}
-------------------------------------

### Total - Engagement and Engaged Users on Facebook Page

```{r}


dscrs2 <- as.list(pages[1,])




highchart(type = "stock")  %>%
  #hc_add_series(sent_total, color = "blue") %>% 
  #hc_credits(enabled = TRUE) %>%
  #hc_exporting(enabled = TRUE) 
  hc_add_series(
  make_xts(cumsums$daily_post_engagements, cumsums$date), 
  name = "Page Engagement", type = "area", color = "red"
  ) %>% 
  hc_add_series(
  make_xts(cumsums$daily_page_engaged_users, cumsums$date), 
  name = "Total Engagers", type = "area", color = "green"
  ) %>% 
  hc_add_theme(hc_theme_smpl()) %>%
  hc_legend(enabled = T, align = "right", verticalAlign = "top",
            layout = "vertical", x = -50, y = 30, 
            floating = T, itemStyle = list(
            color = 'black',
            fontSize = "13px"
   )) %>% 
  hc_rangeSelector(enabled = T, buttons = list(
    list(type = 'all', text = 'All'),
    list(type = 'month', count = 3, text = '3M'),
    list(type = 'month', count = 2, text = '2M'),
    list(type = 'month', count = 1, text = '1M'),
    list(type = 'week', count = 2, text = '2Wks'),
    list(type = 'week', count = 1, text = '1Wk')
  )) %>% 
  hc_exporting(
    enabled = TRUE
  ) %>% 
  hc_plotOptions(area = list(
    stacking = "normal",
    lineColor = "#666666",
    lineWidth = 1,
    marker = list(
      lineWidth = 1,
      lineColor = "666666"
    )
  ))



```

### Daily - Engagement and Engaged Users on Facebook Page

```{r}

highchart(type = "stock")  %>%
  #hc_add_series(sent_total, color = "blue") %>% 
  #hc_credits(enabled = TRUE) %>%
  #hc_exporting(enabled = TRUE) 
  hc_add_series(
  make_xts(pages$daily_post_engagements, pages$date), 
  name = "Page Engagement", type = "line", color = "red"
  ) %>% 
  hc_add_series(
  make_xts(pages$daily_page_engaged_users, pages$date), 
  name = "Total Engagers", type = "area", color = "green"
  ) %>% 
  hc_add_theme(hc_theme_smpl()) %>%
  hc_legend(enabled = T, align = "right", verticalAlign = "top",
            layout = "vertical", x = -50, y = 30, 
            floating = T, itemStyle = list(
            color = 'black',
            fontSize = "13px"
   )) %>% 
  hc_rangeSelector(enabled = T, buttons = list(
    list(type = 'all', text = 'All'),
    list(type = 'month', count = 3, text = '3M'),
    list(type = 'month', count = 2, text = '2M'),
    list(type = 'month', count = 1, text = '1M'),
    list(type = 'week', count = 2, text = '2Wks'),
    list(type = 'week', count = 1, text = '1Wk')
  )) %>% 
  hc_exporting(
    enabled = TRUE
  )
```

Column {data-width=180}
-------------------------------------

### Descriptives

*Click on the Names in the Legend to enable/disable their visualization in the chart*

*Legend:*

**(Daily) Page Engagement**

The number of times people have engaged with your posts through like, comments and shares and more.

**(Daily) Page Engaged Users**

The number of people who engaged with your Page. Engagement includes any click or story created. (Unique Users).


Video Views on Facebook Page  {data-navmenu="Page Impact"}
=========================================

Column {.tabset .tabset-fade}
-------------------------------------

### Total - Video Views on Facebook Page

```{r}

videos_views <- readr::read_csv("data/videos_views.csv") %>% janitor::clean_names()

descriptives <- as.list(videos_views[1,])

videos_views %<>% filter(!is.na(date)) %>% 
  select(-date) %>% 
  mutate_all(funs(as.numeric)) %>% 
  cbind(reach %>% filter(!is.na(date)) %>% select(date), .)

cumsum_video <- videos_views %>% 
  mutate_if(.predicate = is.numeric, .funs = if_else_replace) %>% 
  mutate_if(.predicate = is.numeric, .funs = cumsum)


highchart(type = "stock")  %>%
  #hc_add_series(sent_total, color = "blue") %>% 
  #hc_credits(enabled = TRUE) %>%
  #hc_exporting(enabled = TRUE) 
#  hc_add_series(
#  make_xts(cumsum_reach$daily_total_reach, cumsum_reach$date), 
#  name = "Total Reach", type = "line", color = "darkblue"
#  ) %>% 
  hc_add_series(
  make_xts(cumsum_video$daily_total_promoted_views, cumsum_video$date), 
  name = "Total Promoted Video Views", type = "area", color = "red"
  ) %>% 
  hc_add_series(
  make_xts(cumsum_video$daily_total_organic_views, cumsum_video$date), 
  name = "Total Organic Video Views", type = "area", color = "green"
  )    %>%
  hc_add_theme(hc_theme_smpl()) %>%
  hc_legend(enabled = T, align = "right", verticalAlign = "top",
            layout = "vertical", x = -50, y = 30, 
            floating = T, itemStyle = list(
            color = 'black',
            fontSize = "13px"
   )) %>% 
  hc_rangeSelector(enabled = T, buttons = list(
    list(type = 'all', text = 'All'),
    list(type = 'month', count = 3, text = '3M'),
    list(type = 'month', count = 2, text = '2M'),
    list(type = 'month', count = 1, text = '1M'),
    list(type = 'week', count = 2, text = '2Wks'),
    list(type = 'week', count = 1, text = '1Wk')
  )) %>% 
  hc_exporting(
    enabled = TRUE
  ) %>% 
  hc_plotOptions(area = list(
    stacking = "normal",
    lineColor = "#666666",
    lineWidth = 1,
    marker = list(
      lineWidth = 1,
      lineColor = "666666"
    )
  ))



```

### Daily - Video Views on Facebook Page

```{r}


highchart(type = "stock")  %>%
  #hc_add_series(sent_total, color = "blue") %>% 
  #hc_credits(enabled = TRUE) %>%
  #hc_exporting(enabled = TRUE) 
  hc_add_series(
  make_xts(videos_views$daily_total_video_views, videos_views$date), 
  name = "Daily Total Views", type = "line", color = "darkblue"
  ) %>% 
  hc_add_series(
  make_xts(videos_views$daily_total_promoted_views, videos_views$date), 
  name = "Daily Promoted Video Views", type = "line", color = "red"
  ) %>% 
  hc_add_series(
  make_xts(videos_views$daily_total_organic_views, videos_views$date), 
  name = "Daily Organic Video Views", type = "line", color = "green"
  ) %>% 
  hc_add_theme(hc_theme_smpl()) %>%
  hc_legend(enabled = T, align = "right", verticalAlign = "top",
            layout = "vertical", x = -50, y = 30, 
            floating = T, itemStyle = list(
            color = 'black',
            fontSize = "13px"
   )) %>% 
  hc_rangeSelector(enabled = T, buttons = list(
    list(type = 'all', text = 'All'),
    list(type = 'month', count = 3, text = '3M'),
    list(type = 'month', count = 2, text = '2M'),
    list(type = 'month', count = 1, text = '1M'),
    list(type = 'week', count = 2, text = '2Wks'),
    list(type = 'week', count = 1, text = '1Wk')
  )) %>% 
  hc_exporting(
    enabled = TRUE
  )

```



Column {data-width=280}
-------------------------------------

### Descriptives

*Click on the Names in the Legend to enable/disable their visualization in the chart*

*Legend:*

**(Daily) Total Video Views**

Total number of times videos have been viewed for more than 3 seconds. (Total Count).

**(Daily) Promoted Video Views**

Number of times a promoted video has been viewed for more than 3 seconds (Total Count).

**(Daily) Organic Videos**

Number of times a video has been viewed due to organic reach (Total Count)

```{r}
viewing <- cumsum_video %>% 
   .[nrow(cumsum_video),2:4]

colnames(viewing) <- c("Total Video Views", "Total Promoted Video Views", "Total Organic Video Views")

viewing %<>% 
#  .[1,] %>% 
  gather() 

colnames(viewing) <- c("Measure", "Total Number (October 8th 2017 - January 6th 2018)")

knitr::kable(viewing)

plot_dat <- viewing[-1,] %>% 
  mutate(perc = round(`Total Number (October 8th 2017 - January 6th 2018)`/sum(`Total Number (October 8th 2017 - January 6th 2018)`)*100,2))



#pos <- c(2, 23, 66) + 5

#cumsum(plot_dat$perc) - (0.5 * plot_dat$perc) - 20
  
 ax <- list(
   title = "",
   zeroline = FALSE,
   showline = FALSE,
   showticklabels = FALSE,
   showgrid = FALSE
 )
 
 m <- list(
   l = 10,
   r = 10,
   b = 20,
   t = 30,
   pad = 0
 )
 
 plotly::plot_ly(plot_dat, 
                 x = ~perc, 
                 y = ~1, 
                 orientation = 'h', 
                 type = 'bar',
                 color = ~Measure,
                 text = ~perc, 
                 hoverinfo = 'text') %>% 
 plotly::layout(legend = 
                  list(orientation = 'v'),
                title = "Percentage (%)",
                xaxis = 
                  list(title = ''),
                yaxis = ax,
                barmode = "stack", 
                autosize = F, width = 600, height = 130, margin = m) 
```






Total Page Likes {data-navmenu="Maps"}
=========================================


```{r}

cntry_likes <- readr::read_csv("data/cntry_likes.csv") %>% janitor::clean_names()

city_likes <- readr::read_csv("data/city_likes.csv")


city_likes <- city_likes %>% filter(!is.na(Date))# %>% 
 # select(-Date)

cities_likes <- colnames(city_likes) %>% str_replace("Lifetime Likes by City - ", "")

library(ggmap) 

#gg_codes <- geocode(cities_likes)
#
#cities_likes %<>% 
#  cbind(gg_codes) 
#
#colnames(cities_likes) <- c("city", "lon", "lat")
#cities_likes <- cities_likes[-1,]
#save(cities_likes, file ="data/cities_likes.Rdata")

load("data/cities_likes.Rdata")

city_likes %<>%  
  mutate(`Lifetime Likes by City - 6 October City, Giza Governorate, Egypt` = as.numeric(`Lifetime Likes by City - 6 October City, Giza Governorate, Egypt`)) %>% 
  mutate_if(.predicate = is.numeric, .funs =  na.lomf) %>% 
  .[nrow(city_likes),] %>% 
  gather("city",  "likes", -Date) %>% 
  select(-Date) %>% 
  mutate(likes = as.numeric(likes)) %>% 
#  group_by(city) %>% 
#  summarise(reach = sum(reach, na.rm = T)) %>% 
  mutate(city = colnames(city_likes %>%  select(-Date)) %>% str_replace("Lifetime Likes by City - ", "")) %>% 
  left_join(cities_likes, by = "city") %>% 
  rename(z = likes) %>% 
  rename(name = city)


#dscrs4 <- as.list(cntry_likes[1,])

stops <- data.frame(
  q = 0:5/5,
  #c = viridis::viridis(6, option = "A"),
  c = c(#"#f7fcf5",
#"#e5f5e0",
#"#c7e9c0",
"#a1d99b",
    "#74c476",
    "#41ab5d",
"#238b45",
"#006d2c",
"#00441b"),
  stringsAsFactors = FALSE
) %>% highcharter::list_parse2()

cntry_likes %<>% filter(!is.na(date)) 

cntry <- colnames(cntry_likes)[-1] %>% str_extract("..$") %>% 
  countrycode::countrycode("iso2c", "country.name") 

#cntry[134] <- "Kosovo"

cntry <- c("date", cntry)

colnames(cntry_likes) <- cntry

cntry_likes %<>% 
  mutate(`United Arab Emirates` = as.numeric(`United Arab Emirates`)) %>% 
  mutate_if(.predicate = is.numeric, .funs =  na.lomf) %>% 
  .[nrow(cntry_likes),]


cntry_likes %<>% 
  gather("cntry", "likes", -date) %>% 
  mutate(likes = as.numeric(likes)) %>% 
  mutate(iso3 = countrycode::countrycode(cntry, "country.name", "iso3c"))

total <- 10981 #cntry_likes %>% select(likes) %>% sum()

cntry_likes %>% 
  select(iso3, likes) %>% 
#  group_by(iso3) %>% 
#  summarize(follows = sum(follows, na.rm = T)) %>% 
  hc_world_map(
    iso3 = "iso3", 
    value = "likes",
    nullColor = "lightgrey",
                borderWidth = 0
  ) %>%
  highcharter::hc_colorAxis(stops = stops) %>%
  highcharter::hc_title(
    text = paste0("Total Page Likes (",total, " on January 6th 2018)")
  ) %>% 
  highcharter::hc_subtitle(text = "Based on Data from Omar Saif Ghobash's Facebook page.") %>%
#  highcharter::hc_credits(enabled = TRUE, text = "Based on Data from Omar Saif Ghobash's Facebook page") %>% 
  highcharter::hc_add_theme(highcharter::hc_theme_smpl()) %>% 
  highcharter::hc_mapNavigation(enabled = TRUE) %>% 
  hc_add_series(data = na.omit(city_likes), type = "mapbubble",
                minSize = 0, maxSize = 30,
                name = "City") %>% 
  hc_exporting(
    enabled = TRUE
  )




```

Total Page Follows  {data-navmenu="Maps"}
=========================================


```{r}
cntry_follows <- readr::read_csv("data/cntry_follows.csv") %>% janitor::clean_names()

city_follows <- readr::read_csv("data/city_follows.csv")


city_follows <- city_follows %>% filter(!is.na(Date))# %>% 
 # select(-Date)
# 
# cities_follows <- colnames(city_follows) %>% str_replace("Lifetime Follows by City - ", "")
# 
# library(ggmap) 
# 
# gg_codes <- geocode(cities_follows)
# 
# cities_follows %<>% 
#   cbind(gg_codes) 
# 
# colnames(cities_follows) <- c("city", "lon", "lat")
# cities_follows <- cities_follows[-1,]
# save(cities_follows, file ="data/cities_follows.Rdata")

load("data/cities_follows.Rdata")

city_follows %<>%  
  mutate(`Lifetime Follows by City - 6 October City, Giza Governorate, Egypt` = as.numeric(`Lifetime Follows by City - 6 October City, Giza Governorate, Egypt`)) %>% 
  mutate_if(.predicate = is.numeric, .funs =  na.lomf) %>% 
  .[nrow(city_follows),] %>% 
  gather("city",  "follows", -Date) %>% 
  select(-Date) %>% 
  mutate(follows = as.numeric(follows)) %>% 
#  group_by(city) %>% 
#  summarise(reach = sum(reach, na.rm = T)) %>% 
  mutate(city = colnames(city_follows %>%  select(-Date)) %>% str_replace("Lifetime Follows by City - ", "")) %>% 
  left_join(cities_follows, by = "city") %>% 
  rename(z = follows) %>% 
  rename(name = city)


cntry_follows %<>% filter(!is.na(date)) 

cntry <- colnames(cntry_follows)[-1] %>% str_extract("..$") %>% 
  countrycode::countrycode("iso2c", "country.name") 

#cntry[134] <- "Kosovo"

cntry <- c("date", cntry)

colnames(cntry_follows) <- cntry



cntry_follows %<>% 
  mutate(`United Arab Emirates` = as.numeric(`United Arab Emirates`)) %>% 
  mutate_if(.predicate = is.numeric, .funs =  na.lomf) %>% 
  .[nrow(cntry_follows),]


cntry_follows %<>% 
  gather("cntry", "follows", -date) %>% 
  mutate(follows = as.numeric(follows)) %>% 
  mutate(iso3 = countrycode::countrycode(cntry, "country.name", "iso3c"))

total <- 11047 #cntry_follows %>% select(follows) %>%  sum()

cntry_follows %>% 
  select(iso3, follows) %>% 
#  group_by(iso3) %>% 
#  summarize(follows = sum(follows, na.rm = T)) %>% 
  hc_world_map(
    iso3 = "iso3", 
    value = "follows",
    nullColor = "lightgrey",
                borderWidth = 0
  ) %>%
  highcharter::hc_colorAxis(stops = stops) %>%
  highcharter::hc_title(
    text = paste0("Total Page Follows (",total, " on January 6th 2018)")
  ) %>% 
  highcharter::hc_subtitle(text = "Based on Data from Omar Saif Ghobash's Facebook page.") %>%
#  highcharter::hc_credits(enabled = TRUE, text = "Based on Data from Omar Saif Ghobash's Facebook page") %>% 
  highcharter::hc_add_theme(highcharter::hc_theme_smpl()) %>% 
  highcharter::hc_mapNavigation(enabled = TRUE) %>% 
  hc_add_series(data = na.omit(city_follows), type = "mapbubble",
                minSize = 0, maxSize = 30,
                name = "City") %>% 
  hc_exporting(
    enabled = TRUE
  ) 



```

Total Page Reach {data-navmenu="Maps" data-commentary-width=560}
=========================================



```{r}
cntry_daily_reach <- readr::read_csv("data/cntry_daily_reach.csv") %>% janitor::clean_names()

# dscrs3 <- as.list(cntry_daily_reach[1,])

cntry_daily_reach %<>% filter(!is.na(date)) 

cntry <- colnames(cntry_daily_reach)[-1] %>% str_extract("..$") %>% 
  countrycode::countrycode("iso2c", "country.name") 

cntry[134] <- "Kosovo"

cntry <- c("date", cntry)

colnames(cntry_daily_reach) <- cntry

cntry_daily_reach %<>% 
  gather("cntry", "reach", -date) %>% 
  mutate(reach = as.numeric(reach)) %>% 
  group_by(cntry) %>% 
  summarise(reach = sum(reach, na.rm = T)) %>% 
  mutate(reach = ifelse(is.nan(reach), NA, reach)) %>% 
  mutate(
    iso3 = countrycode::countrycode(
      cntry, 
      origin = "country.name", 
      destination = "iso3c"))

```

```{r}

# weekly <- cntry_daily_reach %>% 
#   mutate(wks = lubridate::week(date)) %>% 
#   group_by(wks) %>% 
#   arrange(date) %>% 
#   slice(1) %>% 
#   select(date, wks)
# 
# cntry_weekly_reach <- cntry_daily_reach %>% 
#   mutate(wks = lubridate::week(date)) %>% 
#   group_by(wks, cntry) %>% 
#   summarise(reach = sum(reach, na.rm = T)) %>% 
#   mutate(reach = ifelse(is.nan(reach), NA, reach)) %>% 
#   left_join(weekly, by = "wks") %>% 
#   mutate(
#     iso3 = countrycode::countrycode(
#       cntry, 
#       origin = "country.name", 
#       destination = "iso3c"))
```

```{r}

data(worldgeojson, package = "highcharter")

city_daily_reach <- readr::read_csv("data/city_daily_reach.csv") 

city_daily_reach <- city_daily_reach %>% filter(!is.na(Date)) #%>% 
  #select(-Date)

cities <- city_daily_reach %>% select(-Date) %>% 
        colnames() %>% str_replace("Daily Reach by City - ", "")

#devtools::install_github("geonames","barryrowlingson")

GNsearch_all <- function(x) {  
  res <- geonames::GNsearch(q=x, username = "favstats")  
  return(bind_rows(res[1,])) 
}

#gg_codes <- stringi::stri_enc_toutf8(cities) %>% 
#  map(GNsearch_all) %>% bind_rows()
#
#cities %<>% 
#  cbind(gg_codes) 
#

#cities <- gg_codes %>% 
#  select(name, lng, lat) 

#colnames(cities) <- c("city", "lon", "lat")
#
#save(cities, file = "data/cities.Rdata")

#save(gg_codes, file = "data/gg_codes.Rdata")
load("data/gg_codes.Rdata")

cities <- gg_codes %>% 
  cbind(cities)


load("data/cities.Rdata")

city_daily_reach %<>% 
  gather("name",  "reach", -Date) %>% 
  select(-Date) %>% 
  mutate(reach = as.numeric(reach)) %>% 
  group_by(name) %>% 
  summarise(reach = sum(reach, na.rm = T)) %>% 
  mutate(name = cities$name) %>% 
  left_join(cities, by = "name")  %>% 
  rename(z = reach) %>% 
  mutate(name = case_when(
    name == "Rye" ~ "New York",
    TRUE ~ name
  ))

city_daily_reach %>% 
  mutate(iso3 = countrycode::countrycode(countryName, "country.name", "iso3c")) %>% 
  select(iso3, z) %>% 
  na.omit() %>% 
  group_by(iso3) %>% 
  summarise(z = sum(z, na.rm = T)) %>% 
  left_join(cntry_daily_reach, by = "iso3") %>% 
  mutate(reach = z + reach) %>% 
  select(iso3, reach) %>% 
  group_by(iso3) %>% 
  summarize(reach = sum(reach, na.rm = T)) %>% 
  hc_world_map(
    iso3 = "iso3", 
    value = "reach",
    nullColor = "lightgrey",
                borderWidth = 0
  ) %>%
  highcharter::hc_colorAxis(stops = stops) %>%
  highcharter::hc_title(
    text = "Total Page Reach (October 8th 2017 - January 6th 2018)"
  ) %>% 
  highcharter::hc_subtitle(text = "Based on Data from Omar Saif Ghobash's Facebook page. (Unique users: 185.502)") %>%
#  highcharter::hc_credits(enabled = TRUE, text = "Based on Data from Omar Saif Ghobash's Facebook page") %>% 
  highcharter::hc_add_theme(highcharter::hc_theme_smpl()) %>% 
  highcharter::hc_mapNavigation(enabled = TRUE)  %>% 
  hc_add_series(data = na.omit(city_daily_reach %>% 
                                 rename(lon = lng) %>% 
                                 mutate(name = paste(name, "| ", 
                                                     adminName1, "| ", 
                                                     countryName)) %>% 
                                 select(name, lon, lat, z)), type = "mapbubble",
                minSize = 0, maxSize = 30,
                name = "City") %>% 
  hc_exporting(
    enabled = TRUE
  ) 



```




```{r, eval = F}

city_daily_reach <- readr::read_csv("data/city_daily_reach.csv") 

city_daily_reach <- city_daily_reach %>% filter(!is.na(Date))# %>% 
 # select(-Date)

cities <- colnames(city_daily_reach) %>% str_replace("Daily Reach by City - ", "")

library(ggmap) 
#
#gg_codes <- geocode(cities)
#
#cities %<>% 
#  cbind(gg_codes) 
#
#colnames(cities) <- c("city", "lon", "lat")
#
#save(cities, file ="cities.Rdata")

load("cities.Rdata")

city_daily_reach %<>% 
  gather("city",  "reach", -Date) %>% 
  select(-Date) %>% 
  mutate(reach = as.numeric(reach)) %>% 
  group_by(city) %>% 
  summarise(reach = sum(reach, na.rm = T)) %>% 
  mutate(city = colnames(city_daily_reach %>%  select(-Date)) %>% str_replace("Daily Reach by City - ", "")) %>% 
  left_join(cities, by = "city")

#save(city_daily_reach, file = "data/city_daily_reach.Rdata")

```

```{r, eval = F}
library(geojsonio)

data(worldgeojson, package = "highcharter")
class(worldgeojson)
## [1] "json"     "geo_json"


reach_geojson <- geojson_json(city_daily_reach, lat = "lat", lon = "lon")
class(reach_geojson)
## [1] "json"     "geo_json"

highchart(type = "map") %>%
  hc_add_series(mapData = worldgeojson, showInLegend = FALSE) %>%
  hc_add_series(data = reach_geojson, type = "mappoint",
                dataLabels = list(enabled = FALSE),
                name = "Airports", tooltip = list(pointFormat = "{point.name}")) 


hcmap() %>% 
  hc_add_series(data = city_daily_reach, type = "mapbubble",
                minSize = 0, maxSize = 30,
                name = "City") 


```

